#!/usr/bin/env bash
set -euo pipefail

OUT_DIR="${OUT_DIR:-reports}"
mkdir -p "$OUT_DIR"

# meta
cat > "${OUT_DIR}/meta.json" <<EOF
{"generated_at":"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"}
EOF

# secrets
gitleaks detect --no-git -f json -r "${OUT_DIR}/gitleaks.json" || true

# semgrep (SAST)
semgrep --config auto --json -o "${OUT_DIR}/semgrep.json" || true

# Go-specific scans
if [[ -f "go.mod" ]]; then
  gosec -fmt=json -out="${OUT_DIR}/gosec.json" ./... || true
  govulncheck -json ./... > "${OUT_DIR}/govulncheck.json" || true
  if [[ -f "go.sum" ]]; then
    osv-scanner --lockfile=go.sum --format=json > "${OUT_DIR}/osv.json" || true
  fi
fi

# IaC scans
if [[ -d "deploy" || -d "iac" || -d "terraform" ]]; then
  checkov -d . -o json > "${OUT_DIR}/checkov.json" || true
fi

echo "done; reports in ${OUT_DIR}/"
