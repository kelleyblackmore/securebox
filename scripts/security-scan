#!/usr/bin/env bash
set -euo pipefail

OUT_DIR="${OUT_DIR:-reports}"
mkdir -p "$OUT_DIR"

echo "SecureBox Security Scanner"
echo "=========================="
echo "Output directory: ${OUT_DIR}"
echo ""

# meta
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
cat > "${OUT_DIR}/meta.json" <<EOF
{"generated_at":"${TIMESTAMP}","scanner_version":"0.0.1"}
EOF

# secrets - gitleaks
echo "[1/7] Running gitleaks (secrets detection)..."
if gitleaks detect --no-git -f json -r "${OUT_DIR}/gitleaks.json" 2>/dev/null; then
  echo "  [OK] No secrets detected"
else
  echo "  [WARN] Potential secrets found - check gitleaks.json"
fi

# semgrep (SAST)
echo "[2/7] Running semgrep (SAST)..."
if semgrep --config auto --json -o "${OUT_DIR}/semgrep.json" 2>/dev/null || true; then
  FINDINGS=$(jq -r '.results | length' "${OUT_DIR}/semgrep.json" 2>/dev/null || echo "0")
  echo "  [OK] Found ${FINDINGS} findings"
fi

# SBOM generation
echo "[3/7] Generating SBOM with syft..."
syft scan dir:. -o json > "${OUT_DIR}/sbom.json" 2>/dev/null || true
syft scan dir:. -o spdx-json > "${OUT_DIR}/sbom-spdx.json" 2>/dev/null || true
echo "  [OK] SBOM generated"

# Container image vulnerability scanning with trivy (if Docker images present)
if command -v docker &> /dev/null && docker images -q | head -1 &> /dev/null; then
  echo "[4/7] Running trivy (container scanning)..."
  # Scan filesystem instead of images for now
  trivy fs --format json --output "${OUT_DIR}/trivy-fs.json" . 2>/dev/null || true
  echo "  [OK] Filesystem scan complete"
else
  echo "[4/7] Running trivy (filesystem scanning)..."
  trivy fs --format json --output "${OUT_DIR}/trivy-fs.json" . 2>/dev/null || true
  echo "  [OK] Filesystem scan complete"
fi

# Go-specific scans
if [[ -f "go.mod" ]]; then
  echo "[5/7] Running gosec (Go security)..."
  gosec -fmt=json -out="${OUT_DIR}/gosec.json" ./... 2>/dev/null || true
  
  echo "[6/7] Running govulncheck (Go vulnerabilities)..."
  govulncheck -json ./... > "${OUT_DIR}/govulncheck.json" 2>/dev/null || true
  
  if [[ -f "go.sum" ]]; then
    echo "  [INFO] Running osv-scanner (dependency vulnerabilities)..."
    osv-scanner --lockfile=go.sum --format=json > "${OUT_DIR}/osv.json" 2>/dev/null || true
  fi
else
  echo "[5-6/7] Skipping Go scans (no go.mod found)"
fi

# IaC scans
if [[ -d "deploy" || -d "iac" || -d "terraform" || -f "Dockerfile" || -f "docker-compose.yml" ]]; then
  echo "[7/7] Running checkov (IaC security)..."
  checkov -d . -o json > "${OUT_DIR}/checkov.json" 2>/dev/null || true
else
  echo "[7/7] Skipping IaC scan (no IaC files found)"
fi

echo "Generating summary..."
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
cat > "${OUT_DIR}/summary.txt" <<EOF
Security Scan Summary
=====================
Scan completed at: ${TIMESTAMP}

Reports generated:
EOF

ls -1 "${OUT_DIR}"/*.json 2>/dev/null | while read -r file; do
  echo "  - $(basename "$file")" >> "${OUT_DIR}/summary.txt"
done

echo ""
echo "[DONE] Scan complete! Reports available in: ${OUT_DIR}/"
cat "${OUT_DIR}/summary.txt"
